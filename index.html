<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>$MOJO ‚Äî Banana Dash Deluxe üçå</title>
<style>
  :root { --bg:#0a0f1a; --accent:#17c964; --ban:#ffd84d }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:#e9efff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  #wrap{display:flex; align-items:center; justify-content:center; height:100%; padding:10px}
  #frame{position:relative; width:min(96vw,460px); aspect-ratio:9/16; border-radius:18px;
         background:linear-gradient(180deg,#0e1630 0%,#07121f 60%);
         box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 2px #1a2a4a}
  canvas{position:absolute; inset:0; width:100%; height:100%; display:block; border-radius:18px}
  #hud{position:absolute; inset:0; pointer-events:none}
  .bar{position:absolute; top:8px; left:8px; right:8px; display:flex; gap:8px; align-items:center; justify-content:space-between}
  .btn{pointer-events:auto; appearance:none; border:0; border-radius:12px; background:var(--accent); color:#02140b;
       padding:10px 16px; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(23,201,100,.35)}
  .pill{background:rgba(255,255,255,.08); padding:8px 12px; border-radius:999px; font-weight:800; letter-spacing:.3px}
  #bigStart, #overlay{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; text-align:center; backdrop-filter: blur(2px)}
  #bigStart{background:linear-gradient(180deg,rgba(0,0,0,.0),rgba(0,0,0,.15))}
  #overlay{display:none; background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.65))}
  h1{margin:0; font-size:28px; letter-spacing:.3px}
  .tiny{opacity:.85; font-size:12px}

  /* Thumb controls */
  #controls{position:absolute; left:0; right:0; bottom:12px; display:flex; justify-content:space-between; gap:16px; padding:0 12px; pointer-events:none}
  .pad{pointer-events:auto; width:44%; height:54px; border-radius:12px; background:rgba(255,255,255,.07);
       display:flex; align-items:center; justify-content:center; font-weight:900; letter-spacing:.5px;
       user-select:none; -webkit-user-select:none; touch-action:manipulation}
  .pad:active{background:rgba(255,255,255,.12)}

  /* Kill zoom/pan on the game area */
  html, body, #frame, canvas, #controls .pad {
    touch-action: none;
    -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
  }
</style>
</head>
<body>
<div id="wrap">
  <div id="frame">
    <canvas id="game" width="360" height="640"></canvas>

    <div id="hud">
      <div class="bar">
        <button id="btnStart" class="btn">Start</button>
        <div class="pill" id="score">Score: 0</div>
      </div>

      <!-- mobile thumb controls -->
      <div id="controls">
        <div id="padLeft"  class="pad">‚üµ MOVE</div>
        <div id="padRight" class="pad">MOVE ‚ü∂</div>
      </div>
    </div>

    <div id="bigStart">
      <div style="font-weight:900; font-size:20px">$MOJO ‚Äî Banana Dash Deluxe üçå</div>
      <div class="tiny">Tap to jump ‚Ä¢ Move with pads (or ‚Üê ‚Üí keys) ‚Ä¢ Collect bananas ‚Ä¢ Dodge rocks</div>
      <button id="btnBigStart" class="btn" style="padding:14px 22px; font-size:16px">Play Now</button>
      <div class="tiny">Best on mobile ‚Ä¢ Sound on üîä</div>
    </div>

    <div id="overlay">
      <h1>Game Over</h1>
      <div id="final">Score: 0</div>
      <div id="best">Best: 0</div>
      <button id="btnRestart" class="btn">Play Again</button>
      <div class="tiny" id="saveStatus"></div>
    </div>
  </div>
</div>

<script>
/* ====== Telegram params (saving to your Render API) ====== */
const Q = new URLSearchParams(location.search);
const PLAYER_ID = Q.get('uid');
const API_BASE  = Q.get('api');
async function saveScore(score){
  const s=document.getElementById('saveStatus');
  if(!PLAYER_ID || !API_BASE){ s.textContent='Local session (no API).'; return; }
  try{
    const res=await fetch(API_BASE+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:PLAYER_ID,score})});
    const data=await res.json(); s.textContent=data.ok?'Score saved ‚úÖ':'Save failed ‚ùå';
  }catch{ s.textContent='Save error ‚ùå'; }
}

/* ====== Canvas & scaling ====== */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
function resize(){ const d=Math.max(1,Math.min(2,devicePixelRatio||1)); cvs.width=360*d; cvs.height=640*d; ctx.setTransform(d,0,0,d,0,0); }
resize(); addEventListener('resize',resize);

/* ====== Visual helpers ====== */
function drawBG(par){
  const g=ctx.createLinearGradient(0,0,0,640); g.addColorStop(0,'#0f1a3c'); g.addColorStop(.65,'#0a1324'); g.addColorStop(1,'#07121f'); ctx.fillStyle=g; ctx.fillRect(0,0,360,640);
  ctx.globalAlpha=.18; ctx.fillStyle='#9db7ff'; for(let i=0;i<60;i++){const x=(i*53+(Date.now()/35))%360, y=(i*89)%640; ctx.fillRect(x,y,2,2);} ctx.globalAlpha=1;
  ctx.fillStyle="#0b1f3a"; ctx.beginPath(); ctx.moveTo(0,420+par*0.2); ctx.lineTo(100,360+par*0.2); ctx.lineTo(200,420+par*0.2); ctx.lineTo(280,380+par*0.2); ctx.lineTo(360,420+par*0.2); ctx.lineTo(360,640); ctx.lineTo(0,640); ctx.closePath(); ctx.fill();
  ctx.fillStyle="#0c2c2a"; for(let i=0;i<8;i++){const x=((i*50+(Date.now()/20))%420)-30; ctx.beginPath(); ctx.arc(x,500+par*0.4,30,0,Math.PI*2); ctx.fill();}
  ctx.fillStyle="#092018"; ctx.fillRect(0,600,360,40);
}
function drawBanana(x,y,r,rot){ ctx.save(); ctx.translate(x,y); ctx.rotate(rot||-0.4); ctx.fillStyle='#ffd84d'; ctx.beginPath(); ctx.ellipse(0,0,r*1.6,r*0.8,0,0,Math.PI*2); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#ccac2e'; ctx.beginPath(); ctx.arc(0,0,r*1.2,-0.9,0.9); ctx.stroke(); ctx.restore(); }
function drawRock(x,y,r){ const g=ctx.createRadialGradient(x-r*0.4,y-r*0.4,r*0.2,x,y,r*1.1); g.addColorStop(0,'#a9b0ba'); g.addColorStop(1,'#636b75'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.stroke(); }

/* ====== MOJO mascot (custom coin face) ====== */
function drawMOJO(p){
  ctx.save(); ctx.translate(p.x,p.y);
  // coin base + glow
  ctx.shadowColor='rgba(255,216,77,.55)'; ctx.shadowBlur=12;
  ctx.fillStyle='#ffd84d'; ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;

  // rim
  ctx.lineWidth=3; ctx.strokeStyle='#ccac2e';
  ctx.beginPath(); ctx.arc(0,0,p.r-2,0,Math.PI*2); ctx.stroke();

  // 'M' eyes and banana smile = MOJO vibe
  ctx.fillStyle='#2b2014';
  // left 'M' eye
  ctx.save(); ctx.translate(-7,-5);
  ctx.beginPath(); ctx.moveTo(-4,4); ctx.lineTo(-4,-4); ctx.lineTo(-1,-1); ctx.lineTo(2,-4); ctx.lineTo(2,4); ctx.closePath(); ctx.fill();
  ctx.restore();
  // right 'M' eye
  ctx.save(); ctx.translate(7,-5);
  ctx.beginPath(); ctx.moveTo(-4,4); ctx.lineTo(-4,-4); ctx.lineTo(-1,-1); ctx.lineTo(2,-4); ctx.lineTo(2,4); ctx.closePath(); ctx.fill();
  ctx.restore();
  // banana smile
  ctx.strokeStyle='#2b2014'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.arc(0,7,8,0,Math.PI); ctx.stroke();

  ctx.restore();
}

/* ====== Math/util ====== */
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y; return Math.hypot(dx,dy);}

/* ====== Game state ====== */
let player, bananas=[], rocks=[], score=0, running=false, tPrev=performance.now(), lastSpawn=0, par=0, bestLocal=+localStorage.getItem('mojo_best')||0;
let vx=0, ax=0;                     // horizontal motion
const MOVE_ACC=0.6, AIR_RES=0.90, MAX_SPEED=5.2;

function reset(){
  player={x:180,y:560,r:18,vy:0,onGround:true};
  bananas=[]; rocks=[]; score=0; tPrev=performance.now(); lastSpawn=0; par=0; vx=0; ax=0;
  document.getElementById('score').textContent='Score: 0';
}

function start(){
  document.getElementById('overlay').style.display='none';
  document.getElementById('bigStart').style.display='none';
  reset(); running=true; loop();
}

async function end(){
  running=false;
  bestLocal=Math.max(bestLocal,score); localStorage.setItem('mojo_best',bestLocal);
  document.getElementById('final').textContent='Score: '+score;
  document.getElementById('best').textContent='Best: '+bestLocal;
  document.getElementById('overlay').style.display='flex';
  await saveScore(score);
}

function spawn(dt){
  lastSpawn+=dt;
  if(lastSpawn>700){
    lastSpawn=0;
    bananas.push({x:Math.random()*320+20,y:-20,r:10,rot:Math.random()*0.8-0.4});
    if(Math.random()<0.7) rocks.push({x:Math.random()*300+30,y:-30,r:16});
  }
}

function update(dt){
  par+=dt*0.05;
  // vertical
  player.vy+=0.4; player.y+=player.vy;
  if(player.y>560){player.y=560; player.vy=0; player.onGround=true;} else player.onGround=false;

  // horizontal
  vx += ax; vx *= AIR_RES;
  if(vx> MAX_SPEED) vx= MAX_SPEED;
  if(vx<-MAX_SPEED) vx=-MAX_SPEED;
  player.x += vx;
  if(player.x<20){player.x=20; vx=0;}
  if(player.x>340){player.x=340; vx=0;}

  // falling objects
  const spd=2.3 + Math.min(5, score*0.01);
  bananas.forEach(b=>{ b.y+=spd*1.1; b.rot+=0.02; });
  rocks.forEach(r=>{ r.y+=spd*1.2; });

  // collect & collide
  for(let i=bananas.length-1;i>=0;i--){
    const b=bananas[i];
    if(dist(player,b)<player.r+b.r){ bananas.splice(i,1); score+=10; document.getElementById('score').textContent='Score: '+score; }
    else if(b.y>660) bananas.splice(i,1);
  }
  for(let i=rocks.length-1;i>=0;i--){
    const r=rocks[i];
    if(dist(player,r)<player.r+r.r){ end(); return; }
    else if(r.y>680) rocks.splice(i,1);
  }
}

function draw(){
  drawBG(par);
  bananas.forEach(b=>drawBanana(b.x,b.y,b.r,b.rot));
  rocks.forEach(r=>drawRock(r.x,r.y,r.r));
  drawMOJO(player);
}

function loop(){
  if(!running) return;
  const tNow=performance.now(), dt=tNow-tPrev; tPrev=tNow;
  spawn(dt); update(dt); draw();
  requestAnimationFrame(loop);
}

/* ====== Controls ====== */
// Jump
cvs.addEventListener('pointerdown',()=>{ if(player.onGround) player.vy=-8.5; });

// Thumb pads (hold to move) with preventDefault to stop scroll/zoom
function bindPad(el, dir){
  let down=false;
  const start=(e)=>{ e.preventDefault(); down=true; ax=dir*MOVE_ACC; };
  const stop =(e)=>{ e.preventDefault(); down=false; ax=0; };
  el.addEventListener('pointerdown', start, {passive:false});
  el.addEventListener('pointerup',   stop,  {passive:false});
  el.addEventListener('pointerleave',stop,  {passive:false});
  el.addEventListener('pointercancel',stop, {passive:false});
}
bindPad(document.getElementById('padLeft'), -1);
bindPad(document.getElementById('padRight'), 1);

// Keyboard
const keys={};
addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(keys['ArrowLeft']||keys['a']||keys['A']) ax=-MOVE_ACC;
  if(keys['ArrowRight']||keys['d']||keys['D']) ax= MOVE_ACC;
  if(e.key===' '||e.key==='ArrowUp') { if(player.onGround) player.vy=-8.5; }
});
addEventListener('keyup',e=>{
  keys[e.key]=false;
  const L=(keys['ArrowLeft']||keys['a']||keys['A']); const R=(keys['ArrowRight']||keys['d']||keys['D']);
  ax = R? MOVE_ACC : L? -MOVE_ACC : 0;
});

// Stop iOS double-tap/pinch zoom on frame
let __lastTouchEnd=0;
document.getElementById('frame').addEventListener('touchend',e=>{
  const now=Date.now();
  if(now-__lastTouchEnd<=300){ e.preventDefault(); }
  __lastTouchEnd=now;
},{passive:false});
document.getElementById('frame').addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});

// UI buttons
document.getElementById('btnStart').addEventListener('click', start);
document.getElementById('btnBigStart').addEventListener('click', start);
document.getElementById('btnRestart').addEventListener('click', start);

// First paint
reset(); drawBG(0); drawMOJO({x:180,y:560,r:18});
</script>
</body>
</html>
